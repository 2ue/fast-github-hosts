name: Update GitHub Hosts

on:
  schedule:
    - cron: '0 */2 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Run script
        id: run_script
        run: |
          python generate_github_hosts_pro.py \
            --level extended \
            --output github_hosts_pro \
            --top-ip 3

          # Extract statistics from generated file
          TOTAL_DOMAINS=$(grep -c "^[0-9]" github_hosts_pro || echo "0")
          SUCCESS_COUNT=$(grep -oP "(?<=域名总数: )\d+/\d+" github_hosts_pro | head -1 || echo "N/A")

          echo "total_domains=${TOTAL_DOMAINS}" >> $GITHUB_OUTPUT
          echo "success_count=${SUCCESS_COUNT}" >> $GITHUB_OUTPUT

      - name: Generate commit message
        id: commit_msg
        run: |
          TIMESTAMP=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')

          cat << EOF > commit_message.txt
          Auto update GitHub Hosts

          - Update time: ${TIMESTAMP} (UTC+8)
          - Domain level: EXTENDED
          - Total entries: ${{ steps.run_script.outputs.total_domains }}
          - Success rate: ${{ steps.run_script.outputs.success_count }}
          - Top IPs: 3 per domain
          EOF

          cat commit_message.txt

      - name: Commit and push
        id: commit
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message_file: commit_message.txt
          file_pattern: github_hosts_pro

      - name: Set date for release
        if: steps.commit.outputs.changes_detected == 'true' && github.event_name == 'schedule'
        id: date
        run: |
          HOUR=$(date -u +%H)
          if [ "$HOUR" = "16" ] || [ "$HOUR" = "18" ]; then
            echo "should_release=true" >> $GITHUB_OUTPUT
            echo "date=$(TZ='Asia/Shanghai' date +%Y%m%d)" >> $GITHUB_OUTPUT
            echo "date_display=$(TZ='Asia/Shanghai' date +%Y-%m-%d)" >> $GITHUB_OUTPUT
          else
            echo "should_release=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Release
        if: steps.date.outputs.should_release == 'true'
        uses: ncipollo/release-action@v1
        with:
          tag: v${{ steps.date.outputs.date }}
          name: GitHub Hosts Pro - ${{ steps.date.outputs.date_display }}
          body: Auto-generated hosts file for ${{ steps.date.outputs.date_display }}
          artifacts: github_hosts_pro
          allowUpdates: true
          makeLatest: true
