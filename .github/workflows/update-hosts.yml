name: Update GitHub Hosts

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'generate_github_hosts_ultimate.py'
      - 'github_domains.json'
      - 'requirements.txt'
      - '.github/workflows/update-hosts.yml'

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Run script
        id: run_script
        run: |
          # Backup old hosts file if exists
          if [ -f "github_hosts_ultimate" ]; then
            cp github_hosts_ultimate github_hosts_ultimate.old
          fi

          # Generate new hosts file
          python generate_github_hosts_ultimate.py \
            --level full \
            --output github_hosts_ultimate

          # Extract statistics from generated file
          TOTAL_DOMAINS=$(grep -c "^[0-9]" github_hosts_ultimate || echo "0")
          SUCCESS_COUNT=$(grep -oP "(?<=æˆåŠŸçŽ‡: )\d+/\d+" github_hosts_ultimate | head -1 || echo "N/A")

          echo "total_domains=${TOTAL_DOMAINS}" >> $GITHUB_OUTPUT
          echo "success_count=${SUCCESS_COUNT}" >> $GITHUB_OUTPUT

      - name: Check hosts changes
        id: check_changes
        run: |
          if [ -f "github_hosts_ultimate.old" ]; then
            # Extract hosts entries only (ignore headers with timestamps)
            sed -n '/^# ==.*GitHub Hosts Start/,/^# ==.*GitHub Hosts End/p' github_hosts_ultimate.old | grep -E "^[0-9]" > old_hosts.txt || true
            sed -n '/^# ==.*GitHub Hosts Start/,/^# ==.*GitHub Hosts End/p' github_hosts_ultimate | grep -E "^[0-9]" > new_hosts.txt || true

            # Compare hosts entries
            if diff -q old_hosts.txt new_hosts.txt > /dev/null 2>&1; then
              echo "hosts_changed=false" >> $GITHUB_OUTPUT
              echo "No changes in hosts entries"
            else
              echo "hosts_changed=true" >> $GITHUB_OUTPUT
              echo "Hosts entries changed"
            fi

            # Cleanup
            rm -f github_hosts_ultimate.old old_hosts.txt new_hosts.txt
          else
            # First run, always consider as changed
            echo "hosts_changed=true" >> $GITHUB_OUTPUT
            echo "First run, no previous hosts file"
          fi

      - name: Generate commit message
        if: steps.check_changes.outputs.hosts_changed == 'true'
        id: commit_msg
        run: |
          TIMESTAMP=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')

          cat << EOF > commit_message.txt
          Auto update GitHub Hosts

          - Update time: ${TIMESTAMP} (UTC+8)
          - Domain level: FULL (All domains)
          - Total entries: ${{ steps.run_script.outputs.total_domains }}
          - Success rate: ${{ steps.run_script.outputs.success_count }}
          - Top IPs: 3 per domain
          - Version: Ultimate 3.0.0
          EOF

          cat commit_message.txt

      - name: Commit and push
        if: steps.check_changes.outputs.hosts_changed == 'true'
        id: commit
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message_file: commit_message.txt
          file_pattern: github_hosts_ultimate

      - name: Prepare release info
        if: steps.check_changes.outputs.hosts_changed == 'true'
        id: release_info
        run: |
          # ä½¿ç”¨æ—¥æœŸ+æ—¶é—´ä½œä¸ºtagï¼Œç¡®ä¿å”¯ä¸€æ€§
          TAG=$(TZ='Asia/Shanghai' date +%Y%m%d-%H%M)
          DATE_DISPLAY=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M')
          TIMESTAMP=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')

          echo "tag=v${TAG}" >> $GITHUB_OUTPUT
          echo "date_display=${DATE_DISPLAY}" >> $GITHUB_OUTPUT
          echo "timestamp=${TIMESTAMP}" >> $GITHUB_OUTPUT

      - name: Create Release
        if: steps.check_changes.outputs.hosts_changed == 'true'
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ steps.release_info.outputs.tag }}
          name: GitHub Hosts Ultimate - ${{ steps.release_info.outputs.date_display }}
          body: |
            ðŸš€ Auto-generated GitHub Hosts file

            **Update Time**: ${{ steps.release_info.outputs.timestamp }} (UTC+8)
            **Version**: Ultimate 3.0.0
            **Level**: FULL (All domains)
            **Total Entries**: ${{ steps.run_script.outputs.total_domains }}
            **Success Rate**: ${{ steps.run_script.outputs.success_count }}
            **Top IPs**: 3 per domain

            ---

            ### ä½¿ç”¨æ–¹æ³•

            ä¸‹è½½ `github_hosts_ultimate` æ–‡ä»¶ï¼Œå°†å†…å®¹è¿½åŠ åˆ°ç³»ç»Ÿ hosts æ–‡ä»¶ï¼š
            - Windows: `C:\Windows\System32\drivers\etc\hosts`
            - Linux/Mac: `/etc/hosts`

            ```bash
            # Linux/Mac
            sudo curl -L https://github.com/${{ github.repository }}/releases/download/${{ steps.release_info.outputs.tag }}/github_hosts_ultimate >> /etc/hosts
            ```
          artifacts: github_hosts_ultimate
          allowUpdates: false
          makeLatest: true
